<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player with Progress</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .video-item {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .video-title {
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .play-button {
            background: #e50914;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .play-button:hover {
            background: #f40612;
        }
        
        .play-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .progress-info {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #333;
            border-radius: 6px;
        }
        
        .progress-info.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #444;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            background: #444;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        
        video {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            display: block;
            border-radius: 8px;
        }
        
        .error {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .ready-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .ready-indicator.ready {
            background: #4CAF50;
            color: white;
        }
        
        .ready-indicator.waiting {
            background: #FF9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Video Player with Download Progress</h1>
        
        <div class="video-item">
            <div class="video-title">
                Sintel (129 MB)
                <span id="ready-indicator" class="ready-indicator waiting">Waiting</span>
            </div>
            <button id="playBtn" class="play-button" onclick="startVideo()">
                Play Video
            </button>
            <button class="play-button" onclick="checkProgress()" id="checkBtn" style="display:none">
                Check Progress
            </button>
            
            <div id="progressInfo" class="progress-info">
                <h3>Download Progress</h3>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill">0%</div>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Download Speed</div>
                        <div class="stat-value" id="downloadSpeed">0 KB/s</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Peers</div>
                        <div class="stat-value" id="peers">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Downloaded</div>
                        <div class="stat-value" id="downloaded">0 MB</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Time Remaining</div>
                        <div class="stat-value" id="timeRemaining">--</div>
                    </div>
                </div>
                
                <div id="status" style="margin-top: 10px; font-size: 14px;"></div>
            </div>
            
            <video id="videoPlayer" controls style="display:none"></video>
            <div id="error" class="error" style="display:none"></div>
        </div>
    </div>

    <script>
        const TORRENTIO_URL = 'http://localhost:7000';
        const WEBTORRENT_URL = 'http://localhost:3000';
        const TEST_HASH = '08ada5a7a6183aae1e09d831df6748d566095a10';
        
        let currentInfoHash = null;
        let progressInterval = null;
        
        async function startVideo() {
            const playBtn = document.getElementById('playBtn');
            const checkBtn = document.getElementById('checkBtn');
            const progressInfo = document.getElementById('progressInfo');
            const status = document.getElementById('status');
            const error = document.getElementById('error');
            
            playBtn.disabled = true;
            playBtn.textContent = 'Loading...';
            progressInfo.classList.add('active');
            error.style.display = 'none';
            
            try {
                // Step 1: Get magnet link
                status.textContent = 'Getting magnet link...';
                const magnetResponse = await fetch(`${TORRENTIO_URL}/api/torrent/${TEST_HASH}/magnet`);
                const { magnetLink } = await magnetResponse.json();
                
                // Step 2: Add to WebTorrent
                status.textContent = 'Adding torrent...';
                const streamResponse = await fetch(`${WEBTORRENT_URL}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ magnet: magnetLink })
                });
                
                const streamData = await streamResponse.json();
                currentInfoHash = streamData.infoHash;
                
                // Start monitoring progress
                startProgressMonitoring();
                
                // Show initial progress
                updateProgressDisplay({
                    progress: streamData.progress || 0,
                    downloadSpeed: streamData.downloadSpeed || 0,
                    numPeers: streamData.numPeers || 0,
                    ready: streamData.ready || false
                });
                
                if (streamData.videoFile) {
                    status.textContent = 'Stream URL ready! Starting video...';
                    
                    // Set up video player
                    const video = document.getElementById('videoPlayer');
                    video.style.display = 'block';
                    video.src = streamData.videoFile.streamUrl;
                    
                    // Handle video events
                    video.onloadstart = () => {
                        status.textContent = 'Video loading...';
                    };
                    
                    video.oncanplay = () => {
                        status.textContent = 'Video ready to play!';
                        document.getElementById('ready-indicator').className = 'ready-indicator ready';
                        document.getElementById('ready-indicator').textContent = 'Ready';
                    };
                    
                    video.onerror = (e) => {
                        console.error('Video error:', e);
                        status.textContent = 'Video error - torrent may still be downloading. Keep waiting...';
                    };
                    
                    // Try to play
                    video.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                        status.textContent = 'Click play button on video to start';
                    });
                } else {
                    throw new Error('No video file found in torrent');
                }
                
            } catch (err) {
                console.error('Error:', err);
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
                stopProgressMonitoring();
            } finally {
                playBtn.textContent = 'Play Video';
                playBtn.disabled = false;
                checkBtn.style.display = 'inline-block';
            }
        }
        
        function startProgressMonitoring() {
            // Clear any existing interval
            stopProgressMonitoring();
            
            // Update progress every second
            progressInterval = setInterval(() => {
                if (currentInfoHash) {
                    checkProgress();
                }
            }, 1000);
        }
        
        function stopProgressMonitoring() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }
        
        async function checkProgress() {
            if (!currentInfoHash) return;
            
            try {
                const response = await fetch(`${WEBTORRENT_URL}/progress/${currentInfoHash}`);
                const progress = await response.json();
                
                updateProgressDisplay(progress);
                
                // Stop monitoring if download is complete
                if (progress.progress >= 1) {
                    stopProgressMonitoring();
                    document.getElementById('status').textContent = 'Download complete!';
                }
                
            } catch (err) {
                console.error('Error checking progress:', err);
            }
        }
        
        function updateProgressDisplay(progress) {
            // Update progress bar
            const percent = Math.round((progress.progress || 0) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            
            // Update stats
            document.getElementById('downloadSpeed').textContent = formatSpeed(progress.downloadSpeed || 0);
            document.getElementById('peers').textContent = progress.peers || progress.numPeers || 0;
            document.getElementById('downloaded').textContent = formatSize(progress.downloaded || 0);
            
            // Time remaining
            if (progress.timeRemaining) {
                document.getElementById('timeRemaining').textContent = formatTime(progress.timeRemaining);
            } else {
                document.getElementById('timeRemaining').textContent = '--';
            }
            
            // Update ready indicator
            if (progress.ready || progress.progress > 0.02) {
                document.getElementById('ready-indicator').className = 'ready-indicator ready';
                document.getElementById('ready-indicator').textContent = 'Ready';
            }
        }
        
        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond === 0) return '0 KB/s';
            const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            let unitIndex = 0;
            let speed = bytesPerSecond;
            
            while (speed >= 1024 && unitIndex < units.length - 1) {
                speed /= 1024;
                unitIndex++;
            }
            
            return speed.toFixed(1) + ' ' + units[unitIndex];
        }
        
        function formatSize(bytes) {
            if (bytes === 0) return '0 MB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        }
        
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopProgressMonitoring();
        });
    </script>
</body>
</html> 